#include <Servo.h>
#include <math.h>

// Arduino pin assignment
#define PIN_IR    A0
#define PIN_LED   9
#define PIN_SERVO 10

// Servo range (microseconds)
#define _DUTY_MIN 600
#define _DUTY_NEU 1700
#define _DUTY_MAX 2500

// Distance limits (mm)
#define _DIST_MIN 100.0   // 10cm
#define _DIST_MAX 250.0   // 25cm

// Filter & timing
#define EMA_ALPHA 0.2
#define LOOP_INTERVAL 50

Servo myservo;
unsigned long last_loop_time = 0;

float dist_prev = _DIST_MIN;
float dist_ema  = _DIST_MIN;

void setup() {
  pinMode(PIN_LED, OUTPUT);
  myservo.attach(PIN_SERVO);
  myservo.writeMicroseconds(_DUTY_NEU);
  Serial.begin(1000000);
  Serial.println("Start sensor control...");
}

void loop() {
  unsigned long time_curr = millis();
  if (time_curr - last_loop_time < LOOP_INTERVAL) return;
  last_loop_time = time_curr;

  float a_value, dist_raw;
  int duty;

  // ---------- IR 센서 값 읽기 ----------
  a_value = analogRead(PIN_IR);

  // ---------- 거리 변환 (센서 모델에 맞게 수정 가능) ----------
  dist_raw = 12343.85 * pow(a_value, -1.15);  // GP2Y0A21YK0F 기준 (10~80cm)

  // ---------- 유효 범위 제한 ----------
  if (dist_raw < 50)  dist_raw = 50;
  if (dist_raw > 800) dist_raw = 800;

  // ---------- EMA 필터 ----------
  dist_ema = EMA_ALPHA * dist_raw + (1 - EMA_ALPHA) * dist_prev;
  dist_prev = dist_ema;

  // ---------- LED 제어 ----------
  // ⚠️ 여기서는 constrain() 절대 사용하지 않음
  if (dist_ema >= _DIST_MIN && dist_ema <= _DIST_MAX) {
    digitalWrite(PIN_LED, HIGH);  // 10~25cm 사이 → 켜기
  } else {
    digitalWrite(PIN_LED, LOW);   // 범위 밖 → 끄기
  }

  // ---------- 서보 제어 ----------
  // 서보만 범위 제한 적용
  float dist_for_servo = constrain(dist_ema, _DIST_MIN, _DIST_MAX);
  duty = _DUTY_MIN + (dist_for_servo - _DIST_MIN) * (_DUTY_MAX - _DUTY_MIN) / (_DIST_MAX - _DIST_MIN);
  myservo.writeMicroseconds(duty);

  // ---------- 시리얼 출력 ----------
  Serial.print("IR:");        Serial.print(a_value);
  Serial.print(", dist_raw:");Serial.print(dist_raw);
  Serial.print(", ema:");     Serial.print(dist_ema);
  Serial.print(", LED:");     Serial.print((dist_ema >= _DIST_MIN && dist_ema <= _DIST_MAX) ? 1 : 0);
  Serial.print(", servo:");   Serial.print(duty);
  Serial.println();
}
